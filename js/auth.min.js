AuthModal.setup=function(){this.actionName="auth_action",this.action=":submit[name="+this.actionName+"]",this.form=".auth_form",this.$doc=$(document),this.sendData={$form:null,action:null,formData:null},this.timeout=300};
AuthModal.initialize=function(){var a,u,n;AuthModal.setup(),AuthModal.input.init(),AuthModal.Placeholder.init(),AuthModal.ajaxProgress=!1,AuthModal.$doc.ajaxStart(function(){AuthModal.ajaxProgress=!0}).ajaxStop(function(){AuthModal.ajaxProgress=!1}).on("submit",AuthModal.form,function(t){t.preventDefault();var o,t=$(this),a=t.find(AuthModal.action).val();a&&((o=t.serializeArray()).push({name:AuthModal.actionName,value:a}),AuthModal.sendData={$form:t,action:a,formData:o},AuthModal.controller())}),$(document).on("click",AuthModal.form+" button[type=submit]",function(t){t.preventDefault(),$(this).closest("form").submit()}),$(document).on("keyup",".auth_input",function(){AuthModal.input.set($(this).val())}),$(document).on("keyup",".auth_input_code",(a=AuthModal.input.setAuthCode,u=300,n=0,function(){var t=this,o=arguments;clearTimeout(n),n=setTimeout(function(){a.apply(t,o)},u||0)})),$(document).on("click",".auth_forward",function(t){t.preventDefault(),AuthModal.Forward.toggle.call(this),AuthModal.Timer.resendCode()}),$(document).on("click",".auth_logout",function(t){t.preventDefault(),AuthModal.Forward.toggle.call(this)}),$(document).on("click",".auth_login",function(t){t.preventDefault(),AuthModal.Forward.toggle.call(this)}),$(document).on("click",".auth_resend_code",function(t){t.preventDefault(),AuthModal.Timer.resendCode()}),AuthModal.Provider.init()},$(document).ready(function(t){AuthModal.initialize()});
AuthModal.Message={selector:".auth_message",success:function(s){this.add(s,"auth_success")},error:function(s){this.add(s,"auth_error")},add:function(s,t){var e=$(".auth_form_active"),a=$('<div class="auth_message"/>');a.html(s).addClass(t),e.find(".auth_buttons").after(a),this.show()},hide:function(){$(this.selector).remove()},show:function(){$(this.selector).show()}};
authModalConfig.callbacksObjectTemplate=function(){return{before:[],response:{success:[],error:[]},ajax:{done:[],fail:[],always:[]}}},AuthModal.Callbacks=authModalConfig.Callbacks={Auth:{logout:authModalConfig.callbacksObjectTemplate(),modal:authModalConfig.callbacksObjectTemplate()},Settings:{profile:authModalConfig.callbacksObjectTemplate(),password:authModalConfig.callbacksObjectTemplate(),phone_change:authModalConfig.callbacksObjectTemplate()},Phone:{code:authModalConfig.callbacksObjectTemplate(),confirmation:authModalConfig.callbacksObjectTemplate(),check:authModalConfig.callbacksObjectTemplate()},Email:{login:authModalConfig.callbacksObjectTemplate(),passwordReset:authModalConfig.callbacksObjectTemplate()},Provider:{interrogate:authModalConfig.callbacksObjectTemplate()},NotificationInStock:{subscribe:authModalConfig.callbacksObjectTemplate()}},AuthModal.Callbacks.add=function(a,l,e){if("function"!=typeof e)return!1;a=a.split(".");for(var t=AuthModal.Callbacks,o=0;o<a.length;o++){if(null==t[a[o]])return!1;t=t[a[o]]}return"object"!=typeof t&&(t=[t]),null!=l?t[l]=e:t.push(e),!0},AuthModal.Callbacks.remove=function(a,l){a=a.split(".");for(var e=AuthModal.Callbacks,t=0;t<a.length;t++){if(null==e[a[t]])return!1;e=e[a[t]]}return null!=e[l]&&(delete e[l],!0)};
AuthModal.controller=function(){switch(this.sendData.action){case"auth/phone/code":AuthModal.Phone.code();break;case"auth/phone/confirmation":AuthModal.Phone.confirmation();break;case"auth/phone/check":AuthModal.Phone.check();break;case"auth/logout":AuthModal.Auth.logout();break;case"auth/email/login":AuthModal.Email.login();break;case"auth/email/password/reset":AuthModal.Email.passwordReset();break;case"auth/modal":AuthModal.Auth.modal();break;case"auth/settings/profile":AuthModal.Settings.profile();break;case"auth/settings/password":AuthModal.Settings.password();break;case"auth/settings/phone/change":AuthModal.Settings.phone_change();break;case"auth/interrogate":AuthModal.Provider.interrogate();break;case"auth/service/subscribe":AuthModal.NotificationInStock.subscribe();break;default:return void console.log("Error not found action: "+this.sendData.action)}};
AuthModal.Action={ajaxSuccess:function(a,s,l){this.callbacks[a].response.success=s,this.ajax.call(this,a,l)},ajaxFail:function(a,s,l){this.callbacks[a].ajax.fail=s,this.ajax.call(this,a,l)},ajaxAlways:function(a,s,l){this.callbacks[a].ajax.always=s,this.ajax.call(this,a,l)},ajax:function(a,s){!0===s&&this.ajaxSend(a,AuthModal.Callbacks[this.name][a])},ajaxSend:function(a,s){AuthModal.send(AuthModal.sendData.formData,this.callbacks[a],s)}};
AuthModal.Modal={init:!1,data:null,initialize:function(){$(document).on("click",".auth_modal",function(a){a.target&&!a.target.closest(".auth_modal-content")&&AuthModal.Modal.hide()}),$(document).on("click",".auth_modal-close",function(a){a.preventDefault(),AuthModal.Modal.hide()}),$(document).on("click",".auth_model-btn",function(a){a.preventDefault(),AuthModal.Modal.run("phone_code")}),$(document).on("click",".auth_modal_run",function(a){a.preventDefault();a=$(this).data("form")||"phone_code";AuthModal.Modal.data=$(this).data(),AuthModal.Modal.run(a)})},run:function(a,t){AuthModal.Modal.hide(),AuthModal.Spinner.show(),this.init||(this.init=!0,this.initialize()),jQuery().modal||AuthModal.Modal.Lib();var d={form_key:a};t&&Object.keys(t).map(function(a,o){d[a]=t[a]}),AuthModal.sendData={action:"auth/modal",formData:d},AuthModal.controller()},update:function(a){$(".auth_modal").remove(),$(".auth_modal-backdrop").remove(),$("body").append(a.modal),AuthModal.Modal.show(),AuthModal.Mask.initialize()},show:function(){$("body").addClass("auth_modal-open"),$("#auth_modal").addClass("auth_modal-open"),$("#auth_modal").addClass("show"),$("body").append($('<div class="auth_modal-backdrop">')),AuthModal.ViewPort.update()},hide:function(){$("body").removeClass("auth_modal-open"),$("#auth_modal").remove(),$(".auth_modal-backdrop").remove(),AuthModal.ViewPort.return()},Lib:function(a){$.getScript(authModalConfig.jsUrl+"lib/jquery.modal.js",function(){})}},AuthModal.Modal.initialize();
AuthModal.Auth=Object.assign({name:"Auth",callbacks:{logout:authModalConfig.callbacksObjectTemplate(),modal:authModalConfig.callbacksObjectTemplate(),changePassword:authModalConfig.callbacksObjectTemplate()},logout:function(){this.ajaxSuccess("logout",function(a){a.reload&&AuthModal.Forward.reload()},!0)},modal:function(){this.ajaxSuccess("modal",function(a){AuthModal.Modal.update(a)},!0)},changePassword:function(){this.ajaxSuccess("changePassword",function(a){},!0)}},AuthModal.Action),AuthModal.Settings=Object.assign({name:"Settings",callbacks:{profile:authModalConfig.callbacksObjectTemplate(),password:authModalConfig.callbacksObjectTemplate(),phone_change:authModalConfig.callbacksObjectTemplate()},profile:function(){},password:function(){this.ajaxSuccess("password",function(a){a.forward&&AuthModal.Forward.show(a.forward)},!0)},phone_change:function(){this.ajaxFail("phone_change",function(a){a.responseJSON&&a.responseJSON.timer&&AuthModal.Timer.start(a.responseJSON.timer)}),this.ajaxSuccess("phone_change",function(a){AuthModal.Forward.show("phone_confirmation"),a.text&&$("#auth_phone_code_text").html(a.text),AuthModal.Timer.start()},!0)}},AuthModal.Action),AuthModal.Phone=Object.assign({name:"Phone",callbacks:{code:authModalConfig.callbacksObjectTemplate(),confirmation:authModalConfig.callbacksObjectTemplate(),check:authModalConfig.callbacksObjectTemplate()},code:function(){if(!AuthModal.Validate.field("phone"))return!1;this.ajaxFail("code",function(a){a.responseJSON&&a.responseJSON.timer&&AuthModal.Timer.start(a.responseJSON.timer)}),this.ajaxSuccess("code",function(a){a.reload&&AuthModal.Forward.reload(),AuthModal.Forward.show("phone_confirmation"),a.text&&$("#auth_phone_code_text").html(a.text),AuthModal.Timer.start()},!0)},confirmation:function(){this.ajaxSuccess("confirmation",function(a){a.reload?AuthModal.Forward.reload():a.forward?AuthModal.Forward.show(a.forward):AuthModal.Forward.show("in_login")},!0)},check:function(){AuthModal.send(AuthModal.sendData.formData,AuthModal.Phone.callbacks.check,AuthModal.Callbacks.Phone.check)}},AuthModal.Action),AuthModal.Email=Object.assign({name:"Email",callbacks:{login:authModalConfig.callbacksObjectTemplate(),passwordReset:authModalConfig.callbacksObjectTemplate()},login:function(){this.ajaxSuccess("login",function(a){a.reload&&AuthModal.Forward.reload(),AuthModal.Forward.show("in_login")},!0)},passwordReset:function(){this.ajaxSuccess("passwordReset",function(a){var o=$("input[name=email_reset]").val();$("input[name=email]").val(o),AuthModal.Forward.show("email_login"),$(".auth_form"),AuthModal.Message.success("Пароль успешно отправлен на ваш email адрес.")},!0)}},AuthModal.Action);
AuthModal.Form={disable:function(){AuthModal.Error.clear(),AuthModal.Spinner.show(),AuthModal.sendData.$form&&(AuthModal.sendData.$form.addClass("auth_loading"),AuthModal.sendData.$form.find('button[type="submit"]').prop("disabled",!0),AuthModal.sendData.$form.find("input").prop("disabled",!0))},enable:function(){AuthModal.Spinner.hide(),AuthModal.sendData.$form&&(AuthModal.sendData.$form.removeClass("auth_loading"),AuthModal.sendData.$form.find('button[type="submit"]').prop("disabled",!1),AuthModal.sendData.$form.find("input").prop("disabled",!1))}};
AuthModal.send=function(a,o,t){function e(a,o){if("function"==typeof a)return a.apply(o,Array.prototype.slice.call(arguments,2));if("object"==typeof a)for(var t in a)if(a.hasOwnProperty(t))if(!1===a[t].apply(o,Array.prototype.slice.call(arguments,2)))return!1;return!0}$.isArray(a)?a.push({name:"ctx",value:authModalConfig.ctx}):$.isPlainObject(a)?a.ctx=authModalConfig.ctx:"string"==typeof a&&(a+="&ctx="+authModalConfig.ctx);var n,l,r,s="/api/"+AuthModal.sendData.action,u=!!AuthModal.sendData.$form&&AuthModal.sendData.$form.attr("method"),u=u||"post";AuthModal.Form.disable(),AuthModal.Message.hide(),!1!==e(o.before)&&!1!==e(t.before)&&(l=o,r=t,n=$[u](s,a,function(a){e(l.response.success,AuthModal,a),e(r.response.success,AuthModal,a)},"json").done(function(){e(l.ajax.done,AuthModal,n),e(r.ajax.done,AuthModal,n)}).fail(function(a){a.responseJSON&&(a=a.responseJSON).data&&AuthModal.input.handleErrors(a.data),e(l.ajax.fail,AuthModal,n),e(r.ajax.fail,AuthModal,n)}).always(function(){AuthModal.Form.enable(),e(l.ajax.always,AuthModal,n),e(r.ajax.always,AuthModal,n)}))};
AuthModal.Timer={time:59,micro:0,inter:null,start:function(t){$(".auth_timer_text").show(),$(".auth_timer_resend").hide(),this.micro=t||this.time,this.createTime(AuthModal.Timer.micro),this.clear(),this.inter=setInterval(" AuthModal.Timer.fun()",1e3)},clear:function(){clearInterval(AuthModal.Timer.inter)},fun:function(){AuthModal.Timer.micro--,AuthModal.Timer.update(),AuthModal.Timer.micro<=0&&(AuthModal.Timer.clear(),AuthModal.Timer.afterTimeOut())},update:function(){var t=(new Date).getTime(),t=AuthModal.Timer.countDownDate-t,e=Math.floor(t%36e5/6e4),t=Math.floor(t%6e4/1e3),e=(t=(t=0===AuthModal.Timer.micro?e=0:t).toString().padStart(2,"0"),(e=e.toString().padStart(2,"0"))+":"+t);$(".auth_timer").html(e)},afterTimeOut:function(){$(".auth_timer_text").hide(),$(".auth_timer_resend").show()},resendCode:function(){console.log($("#auth_input_phone")),$("#auth_input_phone_code").submit(),$(".auth_input_code").val("")},countDownDate:null,createTime:function(t){var e=new Date;this.countDownDate=new Date(e.getTime()+36e5),this.countDownDate.setSeconds(this.countDownDate.getSeconds()+t)}};
AuthModal.Provider=Object.assign({name:"Provider",service:"",callbacks:{interrogate:authModalConfig.callbacksObjectTemplate()},init:function(){$(document).on("click",".auth_btn_social",function(e){e.preventDefault(),$(this).addClass("disabled");var e=$(this).attr("href"),t=$(this).attr("title");AuthModal.Provider.openWindow(e),AuthModal.Spinner.show(),AuthModal.Spinner.disableHide=!0,AuthModal.Provider.service=t,AuthModal.Provider.circle(t)})},circle:function(){AuthModal.sendData={$form:null,action:"auth/interrogate",formData:{service:AuthModal.Provider.service}},AuthModal.controller()},interrogate:function(){$(".auth_error").remove(),this.ajaxFail("interrogate",function(e){302===e.status?setTimeout(function(){AuthModal.Provider.circle()},1e3):(AuthModal.Spinner.disableHide=!1,AuthModal.Spinner.hide(),e=$('<div class="auth_error">'+e.responseJSON.message+"</div>"),$(".auth_error").remove(),$("#auth_input_phone_code .auth_buttons").after(e))}),this.ajaxSuccess("interrogate",function(e){AuthModal.Spinner.disableHide=!1,AuthModal.Spinner.hide(),AuthModal.Forward.show("in_login")},!0)},openWindow:function(e){window.open(e,authModalConfig.siteName,"height=650,width=600")}},AuthModal.Action);
AuthModal.NotificationInStock=Object.assign({name:"NotificationInStock",callbacks:{subscribe:authModalConfig.callbacksObjectTemplate()},subscribe:function(){AuthModal.Modal.data&&Object.keys(AuthModal.Modal.data).map(function(a,t){AuthModal.sendData.formData.push({name:a,value:AuthModal.Modal.data[a]})}),$(".auth_error").remove(),this.ajaxFail("subscribe",function(a){var t;200!==a.status?(t=$('<div class="auth_error">'+a.responseJSON.message+"</div>"),$(".auth_error").remove(),$("#auth_input_notification_in_stock .auth_buttons").after(t)):a.responseJSON&&a.responseJSON.forward&&AuthModal.Forward.show(a.responseJSON.forward)}),this.ajaxSuccess("subscribe",function(a){AuthModal.Modal.data=null,AuthModal.Forward.show("notification_in_stock_success")},!0)}},AuthModal.Action);
AuthModal.ViewPort={change:!1,current:null,param:"width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no",update:function(){var t;AuthModal.ViewPort.change||(AuthModal.ViewPort.change=!0,(t=this.get())&&!AuthModal.ViewPort.current&&(AuthModal.ViewPort.current=t),this.get().remove(),this.addHead(this.create()))},get:function(){return $("meta[name=viewport]")},return:function(){AuthModal.ViewPort.change&&(AuthModal.ViewPort.change=!1,this.get().remove(),AuthModal.ViewPort.current?this.addHead(AuthModal.ViewPort.current):this.get().remove())},create:function(){return $('<meta name="viewport" content="'+AuthModal.ViewPort.param+'">')},addHead:function(t){$("head").append(t)}};
AuthModal.Validate={field:function(a){var r=!1;switch(a){case"phone":case"email":AuthModal.input.validate()||(r="Номер телефона указан не верно")}return!1!==r?(AuthModal.Error.add(a,r),!1):(AuthModal.Error.clear(),!0)}};
AuthModal.input={value:null,auth_code:null,country_code:authModalConfig.country_code,init:function(){$(".auth_input_no_mask").each(function(t,e){""!==$(this).val()&&$(this).closest(".auth_block_inputs_phone_outer_row").find(".auth_input_placeholder").addClass("auth_input_placeholder_focus")})},set:function(t){t=this.parse(t),!isNaN(t)&&void 0!==t||(t=null),this.value=t,this.placeholderToggle(),$('input[name="auth_phone"]').val(this.get());t=this.get()||"";t&&$("#auth_phone").text(t)},setValue:function(t){this.set(t);t=document.querySelector(".auth_input");t&&t.inputmask.setValue(this.get(!1))},is:function(){return!!this.value},setAuthCode:function(){var t=$(this).val();return 4===(t=t.replace(/[^0-9]/g,"")).length&&(AuthModal.input.auth_code===t||(AuthModal.input.auth_code=t,$("input[name=auth_code]").val(t),void $("#auth_input_code").submit()))},get:function(t){var e=this.value;return e&&(!1!==t?AuthModal.input.country_code+e:e)},validate:function(){var t=this.get();return!!t&&11===t.length},parse:function(t){if(t){if(t=t.replace(/[^0-9]/g,""),t=parseInt(t),isNaN(t)||void 0===t)return null;11!==(t=t.toString()).length||"8"!==t[0]&&t[0]!==AuthModal.input.country_code||(t=t.slice(1))}return t},placeholderToggle:function(){this.is()?this.placeholderHide():this.placeholderShow()},placeholderHide:function(){$(".auth_input_placeholder_toggle").hide()},placeholderShow:function(){$(".auth_input_placeholder_toggle").show()},handleErrors:function(t){for(var e in t){var u;t.hasOwnProperty(e)&&(u=t[e],AuthModal.Error.add(e,u))}}};
AuthModal.Mask={initialize:function(){AuthModal.Mask.impose(".auth_input",{mask:"999 999 9999",placeholder:"_",showMaskOnHover:!1,showMaskOnFocus:!1,onBeforePaste:function(t,n){return AuthModal.input.set(t),AuthModal.input.get(!1)},onBeforeMask:function(t,n){return AuthModal.input.set(t),AuthModal.input.get(!1)}},function(){$(".auth_input").addClass("auth_mask_init")}),AuthModal.Mask.impose(".auth_input_code",{placeholder:"_",mask:"9 9 9 9",clearMaskOnLostFocus:!1},function(){$(".auth_input_code").addClass("auth_mask_init")})},destroy:function(t,n){},impose:function(t,n,a){console.log(t),void 0===jQuery().inputmask?this.lib(t,n,a):this.handle(t,n,a)},handle:function(t,n,a){n=Object.assign({},n),$(t).inputmask(n),"function"==typeof a&&a()},lib:function(t,n,a){$.getScript(authModalConfig.jsUrl+"lib/jquery.inputmask.min.js",function(){AuthModal.Mask.handle(t,n,a)})}};
AuthModal.Spinner={selector:".auth_spinners",disableHide:!1,get:function(){return $(this.selector)},has:function(){return 0<this.get().length},hide:function(){this.disableHide||this.get().removeClass("auth_loading")},show:function(){this.has()||this.reg(),this.get().addClass("auth_loading")},reg:function(){var s=$('<div class="auth_spinners"><div class="auth_spinners_content"><div class="auth_spinner"></div><div class="auth_spinner"></div><div class="auth_spinner"></div><div class="auth_spinner"></div></div></div>');$("body").append(s)}};
AuthModal.Error={add:function(a,e){var a=$("input[name="+a+"]"),o=a.closest(".auth_block_inputs_phone"),a=(o.find(".auth_block_error").remove(),a.closest(".auth_block_inputs_phone_outer")),r=(a.addClass("auth_error"),$('<div class="auth_block_error">')),e=$('<p class="auth_error">').html(e);r.append(e),o.append(r),AuthModal.Error.animated.call(a)},clear:function(){$(".auth_block_inputs_phone_outer").removeClass("auth_error"),$(".auth_block_error").remove()},animated:function(){$(this).addClass("shake"),setTimeout(function(){$(".shake").removeClass("shake")},300)}};
AuthModal.Forward={formId:null,show:function(o,a){this.formId=o,AuthModal.Message.hide(),AuthModal.Error.clear(),$("#auth_modal .auth_form").hide();var e=$('[data-form-id="'+o+'"]');if(0===e.length)return console.error("form not found "+o),!1;$(".auth_form_active").removeClass("auth_form_active"),e.show(),e.addClass("auth_form_active");o=e.find("input[autofocus]");0<o.length&&(o.focus(),a)&&0<(e=$('input[name="'+a+'"]')).length&&o.val(e.val())},toggle:function(){var o=$(this).data("copy");AuthModal.Forward.show($(this).data("form"),o)},reload:function(){this.reload_cancel_one?this.reload_cancel_one=!1:window.location.reload()},reload_cancel_one:!1,reloadCancelOne:function(){this.reload_cancel_one=!0}};
AuthModal.Placeholder={init:function(){$(document).on("focus",".auth input",function(){$(this).closest(".auth_block_inputs_phone_outer").addClass("auth_focus")}),$(document).on("blur",".auth input",function(){""===$(this).val()&&$(".auth_block_inputs_phone_outer").removeClass("auth_focus")}),$(document).on("keyup",".auth input",function(){var t=$(this).closest(".auth_block_inputs_phone_outer_row").find(".auth_input_placeholder");""!==$(this).val()?t.addClass("auth_input_placeholder_focus"):t.removeClass("auth_input_placeholder_focus")})}};
AuthModal.orderPhoneConfirmation={run:function(){$(document).on("click",".auth_confirm_phone",function(o){o.preventDefault(),AuthModal.Forward.reloadCancelOne(),AuthModal.Modal.run("phone_code",{phone:AuthModal.input.get()})}),0<$("#msOrder").length&&AuthModal.Mask.impose("#msOrder input[name=phone]",{mask:"999 999 9999",placeholder:"_",showMaskOnHover:!1,showMaskOnFocus:!1,onBeforePaste:function(o,n){return console.log(o),AuthModal.input.set(o),AuthModal.input.get(!1)},onBeforeMask:function(o,n){return AuthModal.input.set(o),AuthModal.input.get(!1)}},function(){var o=AuthModal.input.get();o&&(AuthModal.sendData={action:"auth/phone/check",formData:{phone:o}},AuthModal.Callbacks.add("Phone.check.response.success","check_phone",function(o){o.numberExists&&AuthModal.orderPhoneConfirmation.confirmMessage()}),AuthModal.Callbacks.add("Auth.modal.response.success","send_code_phone",function(o){$("#auth_input_phone_code").submit()}),AuthModal.controller())})},confirmMessage:function(){var o=$('<small><a href="#" class="auth_confirm_phone">войти на сайт</a></small>');$("#msOrder input[name=phone]").after(o)}};
